- hosts: phpday
  gather_facts: true
  become: yes
  roles:
    - timezone
    - tmux
    - oh-my-zsh
    - geerlingguy.nginx
    - geerlingguy.php
    - geerlingguy.composer
    - geerlingguy.mysql

  tasks:
    - name: Deploy source code from Github.
      git:
        repo: 'https://github.com/zx1986/phpday-laravel'
        dest: /var/www/html/phpday.tw
        version: develop
      register: deploy_source_code_from_github

    - name: Create and change directory permissions.
      file:
        path: "{{ item }}"
        state: directory
        mode: 0777
      with_items:
        - '/var/www/html/phpday.tw/bootstrap/cache'
        - '/var/www/html/phpday.tw/storage'
        - '/var/www/html/phpday.tw/vendor'
      when: deploy_source_code_from_github

    - name: Copy .env file from local to server.
      copy:
        src: phpday.production.env
        dest: /var/www/html/phpday.tw/.env
        mode: 0644
      when: deploy_source_code_from_github

    - name: Composer update.
      composer:
        command: update
        working_dir: /var/www/html/phpday.tw
      register: composer_update
      when: deploy_source_code_from_github
